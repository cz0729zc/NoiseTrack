### **基于STM32F103C8T6的轨道交通噪声监测系统优化方案**

#### **1. 硬件适配调整**
| **模块**     | **选型变更说明**                                             |
| ------------ | ------------------------------------------------------------ |
| **主控芯片** | STM32F103C8T6（需优化算法效率，无硬件浮点改用Q格式定点数运算） |
| **显示模块** | LCD12864（SPI/并口驱动，显示噪声曲线需改用字符模拟折线图）   |
| **4G模块**   | 有人云WH-LTE-7S1（AT指令集，需适配HTTP/MQTT协议）            |
| **存储模块** | 24C02 EEPROM（256字节，仅存储阈值和关键日志，历史数据改由云端保存） |

#### **2. 关键修改点**
**① 噪声数据处理优化（STM32F103C8T6无硬件浮点）**
```c
// 使用Q15定点数替代浮点运算（示例：噪声计算）
int16_t calculate_Leq_Q15(int16_t *samples, uint32_t N) {
    int32_t sum = 0;
    for(uint32_t i=0; i<N; i++) {
        sum += (samples[i] * samples[i]) >> 8; // Q15乘法调整
    }
    return 10 * log10_Q15(sum / N); // 自定义定点数log10函数
}
```

**② LCD12864显示方案**  
- **曲线显示**：用字符`*`模拟折线（每行32字符，纵轴分8级）  
  ```c
  void draw_noise_curve(uint8_t level) {
      uint8_t row = 7 - (level / 16); // 映射到8行
      lcd_set_cursor(0, row);
      lcd_write_string("***"); // 噪声强度可视化
  }
  ```

**③ 有人云4G模块配置**  
```c
// AT指令发送数据（HTTP示例）
void send_via_4g(float noise) {
    uart_send("AT+HTTPPOST=\"http://api.xxx.com\",\"{\\\"noise\\\":");
    uart_send_float(noise);  // 自定义浮点转字符串函数
    uart_send("}\"\r\n");
}
```

**④ 24C02存储策略**  
- **存储内容**：  
  - 0x00~0x0F：噪声阈值（2字节）  
  - 0x10~0xFF：报警事件日志（时间戳+噪声值）  

#### **3. 优化后系统框图**
```
噪声传感器 → STM32F103C8T6 → LCD12864（实时显示）
               ↓      ↓
           24C02    WH-LTE-7S1 → 云平台
               （报警记录）   （数据持久化）
```

#### **4. 资源占用评估**
| **资源** | **使用情况**         | **备注**      |
| -------- | -------------------- | ------------- |
| Flash    | 约48KB（含4G协议栈） | 需开启-O2优化 |
| RAM      | 5KB（采样缓冲区2KB） | 采样分段处理  |
| EEPROM   | 256字节              | 仅存关键参数  |

#### **5. 注意事项**
1. **实时性保障**：  
   - 4G通信需异步处理（避免阻塞主循环）  
   - 采用DMA采集I2S数据  

2. **显示性能妥协**：  
   - LCD12864刷新率限制在1Hz（防止闪烁）  

3. **成本控制优势**：  
   - 总BOM成本控制在￥150以内（含4G模块）  

此方案在有限硬件资源下，通过软件优化实现了核心功能，适合对成本敏感的轨道交通噪声监测场景。
